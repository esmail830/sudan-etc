# حل مشكلة RLS (Row Level Security)

## 🚨 المشكلة:
```
PostgrestException: new row violates row-level security policy for table "reportc"
code: 42501, details: Unauthorized
```

## 🔍 **ما تعنيه المشكلة:**
- RLS مفعل على الجدول
- السياسات لا تسمح بإدراج بيانات جديدة
- المستخدم غير مصرح له بإنشاء بلاغات

## ✅ **الحل السريع:**

### **الخطوة 1: نفذ ملف إصلاح RLS**
1. اذهب إلى Supabase Dashboard
2. اذهب إلى **SQL Editor**
3. انسخ محتوى `fix_rls_policies.sql`
4. نفذ الأوامر

### **الخطوة 2: اختبار الإصلاح**
```sql
-- اختبار إدراج بيانات
INSERT INTO reportc (type, description, location, legal_agreement_accepted, status)
VALUES ('اختبار', 'وصف اختبار', 'موقع اختبار', true, 'pending');

-- عرض النتيجة
SELECT * FROM reportc WHERE type = 'اختبار';

-- حذف البيانات التجريبية
DELETE FROM reportc WHERE type = 'اختبار';
```

## 🔧 **ما تم إصلاحه:**

### **1. حذف السياسات القديمة**
- إزالة جميع السياسات الموجودة
- تنظيف الجدول من السياسات المعطلة

### **2. إنشاء سياسات جديدة صحيحة**
- **INSERT**: أي شخص يمكنه إنشاء بلاغ
- **SELECT**: أي شخص يمكنه قراءة البلاغات
- **UPDATE**: المستخدم يمكنه تحديث بلاغاته فقط
- **DELETE**: المستخدم يمكنه حذف بلاغاته فقط

### **3. اختبار السياسات**
- إدراج بيانات تجريبية
- التحقق من نجاح العملية
- حذف البيانات التجريبية

## 📋 **خطوات التشخيص:**

### **فحص السياسات الحالية:**
```sql
-- عرض السياسات النشطة
SELECT 
    policyname,
    cmd,
    permissive,
    roles
FROM pg_policies 
WHERE tablename = 'reportc';
```

### **فحص حالة RLS:**
```sql
-- فحص حالة RLS
SELECT 
    schemaname,
    tablename,
    rowsecurity
FROM pg_tables 
WHERE tablename = 'reportc';
```

## ⚠️ **ملاحظات مهمة:**

### **1. RLS مفعل**
- يجب أن يكون RLS مفعل على الجدول
- بدون RLS، لن تعمل السياسات

### **2. السياسات الصحيحة**
- `INSERT WITH CHECK (true)` - يسمح بالإدراج
- `SELECT USING (true)` - يسمح بالقراءة
- `UPDATE/DELETE` - يسمح للمستخدمين بتعديل بلاغاتهم فقط

### **3. اختبار السياسات**
- تأكد من نجاح الإدراج التجريبي
- تحقق من عدم وجود أخطاء

## 🎯 **بعد الإصلاح:**

1. **أعد تشغيل التطبيق**
2. **اضغط على أيقونة ℹ️ لاختبار الاتصال**
3. **حاول إرسال بلاغ جديد**
4. **تحقق من عدم ظهور خطأ RLS**

## 📞 **إذا استمرت المشكلة:**

1. نفذ `fix_rls_policies.sql` مرة أخرى
2. تحقق من Console logs
3. راجع Supabase Dashboard
4. تأكد من نجاح اختبار الإدراج التجريبي

## 🔒 **الأمان:**

- RLS يحمي البيانات
- المستخدمون يرون بلاغاتهم فقط
- أي شخص يمكنه إنشاء بلاغ جديد
- التحديث والحذف مقيدان للمالك
