# ميزة "تذكر تسجيل الدخول" - Sudan Electricity App

## 🎯 الهدف
تمكين المستخدم من البقاء مسجل دخول حتى لو خرج من التطبيق، مع الحاجة لتسجيل الخروج يدوياً فقط.

## ✅ الميزات المضافة

### 1. **حفظ الجلسة تلقائياً**
- حفظ معلومات تسجيل الدخول في `SharedPreferences`
- حفظ معرف المستخدم ورقم الهاتف
- حفظ وقت آخر تسجيل دخول

### 2. **استعادة الجلسة عند بدء التطبيق**
- فحص حالة تسجيل الدخول عند بدء التطبيق
- محاولة استعادة الجلسة من Supabase
- الانتقال التلقائي للشاشة الرئيسية إذا كان مسجل دخول

### 3. **إدارة الجلسة الذكية**
- التحقق من صلاحية الجلسة
- مسح البيانات المحفوظة عند انتهاء الصلاحية
- معالجة الأخطاء بشكل آمن

### 4. **واجهة مستخدم محسنة**
- شاشة تحميل أثناء فحص حالة تسجيل الدخول
- زر تسجيل خروج في AppBar
- مربع حوار تأكيد تسجيل الخروج

## 🔧 كيفية العمل

### عند تسجيل الدخول:
```dart
// حفظ معلومات المستخدم
final prefs = await SharedPreferences.getInstance();
await prefs.setBool('is_logged_in', true);
await prefs.setString('user_id', res.user!.id);
await prefs.setString('user_phone', phone);
await prefs.setString('last_login', DateTime.now().toIso8601String());
```

### عند بدء التطبيق:
```dart
// فحص حالة تسجيل الدخول
final authService = AuthService();
await authService.tryRestoreSession();

// إذا كان مسجل دخول، انتقل للشاشة الرئيسية
if (isLoggedIn) {
  Navigator.pushReplacementNamed(context, '/main');
}
```

### عند تسجيل الخروج:
```dart
// مسح البيانات المحفوظة
await _supabase.auth.signOut();
final prefs = await SharedPreferences.getInstance();
await prefs.clear();
```

## 📱 تجربة المستخدم

### 1. **أول مرة**
- المستخدم يسجل دخول بالهاتف
- يتم حفظ معلومات الجلسة
- الانتقال للشاشة الرئيسية

### 2. **إعادة فتح التطبيق**
- عرض شاشة تحميل
- فحص حالة تسجيل الدخول
- الانتقال التلقائي للشاشة الرئيسية
- **لا حاجة لتسجيل دخول مرة أخرى**

### 3. **تسجيل الخروج**
- الضغط على زر تسجيل الخروج في AppBar
- تأكيد العملية
- العودة لشاشة الترحيب
- مسح جميع البيانات المحفوظة

## 🛠️ الملفات المعدلة

### ملفات جديدة:
- `lib/services/auth_service.dart` - خدمة مصادقة محسنة

### ملفات معدلة:
- `lib/main.dart` - إضافة فحص حالة تسجيل الدخول
- `lib/welcome_screens.dart` - إضافة فحص تلقائي
- `lib/screens/main_screen.dart` - إضافة زر تسجيل الخروج
- `pubspec.yaml` - إضافة package `shared_preferences`

## 📦 المتطلبات

### Dependencies:
```yaml
dependencies:
  shared_preferences: ^2.2.2
  supabase_flutter: ^2.9.1
```

### Permissions (Android):
```xml
<!-- في android/app/src/main/AndroidManifest.xml -->
<uses-permission android:name="android.permission.INTERNET" />
```

## 🔒 الأمان

### 1. **تشفير البيانات**
- استخدام `SharedPreferences` للتخزين المحلي
- البيانات محفوظة على الجهاز فقط

### 2. **صلاحية الجلسة**
- التحقق من صلاحية جلسة Supabase
- مسح البيانات عند انتهاء الصلاحية

### 3. **معالجة الأخطاء**
- تسجيل جميع العمليات
- مسح البيانات عند حدوث خطأ

## 🧪 الاختبار

### 1. **تسجيل الدخول**
```bash
flutter run
# سجل دخول بالهاتف
# تأكد من حفظ البيانات
```

### 2. **إعادة فتح التطبيق**
```bash
# أغلق التطبيق تماماً
# أعد فتحه
# يجب الانتقال للشاشة الرئيسية تلقائياً
```

### 3. **تسجيل الخروج**
```bash
# اضغط على زر تسجيل الخروج
# تأكد من العودة لشاشة الترحيب
```

## 🔍 استكشاف الأخطاء

### إذا لم يتم حفظ الجلسة:
1. تحقق من logs: `[AuthService] تم تسجيل الدخول بنجاح`
2. تأكد من إضافة package `shared_preferences`
3. تحقق من صلاحيات التطبيق

### إذا لم يتم استعادة الجلسة:
1. تحقق من logs: `[Main] تم فحص حالة تسجيل الدخول`
2. تأكد من صحة إعدادات Supabase
3. تحقق من الاتصال بالإنترنت

### إذا فشل تسجيل الخروج:
1. تحقق من logs: `[AuthService] تم تسجيل الخروج بنجاح`
2. تأكد من مسح البيانات المحفوظة
3. تحقق من العودة لشاشة الترحيب

## 📝 ملاحظات مهمة

- **البيانات محفوظة محلياً**: لا يتم رفعها لخادم خارجي
- **صلاحية الجلسة**: تتبع صلاحية جلسة Supabase
- **الأمان**: مسح البيانات عند انتهاء الصلاحية
- **الأداء**: فحص سريع عند بدء التطبيق
- **تجربة المستخدم**: لا حاجة لتسجيل دخول متكرر

## 🚀 المزايا

1. **راحة المستخدم**: لا حاجة لتسجيل دخول متكرر
2. **أمان عالي**: مسح البيانات عند انتهاء الصلاحية
3. **أداء ممتاز**: فحص سريع للجلسة
4. **واجهة محسنة**: شاشة تحميل وزر تسجيل خروج
5. **معالجة أخطاء**: تسجيل شامل لجميع العمليات
